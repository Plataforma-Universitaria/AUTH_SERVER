<!DOCTYPE html>
<html lang="pt-BR" xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Login</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .password-container {
            position: relative;
        }
        #password {
            padding-right: 30px;
        }
        .toggle-password {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
        }
        .toggle-password img {
            width: 20px;
            height: 20px;
        }
        .toggle-password:hover img {
            box-shadow: 0 2px 7px rgba(0, 0, 0, 0.3);
            border-radius: 85%;
        }
        .toggle-password.active img {
            border-radius: 50%;
            background-color: rgba(79, 70, 229, 0.4);
        }
    </style>
</head>
<body class="bg-slate-100">
<div class="flex flex-col justify-center lg:px-8 min-h-full px-6 py-8">
    <div class="mt-5 mx-auto max-w-sm w-full">
        <form class="bg-white overflow-hidden p-10 rounded-xl shadow-lg space-y-3" th:action="@{/login}" method="post">

            <div class="sm:mx-auto sm:w-full sm:max-w-sm">
                <img class="mx-auto h-40 w-50" th:src="@{/images/logo.png}" alt="logo">
            </div>

            <h4 class="font-bold leading-9 mt-10 text-center text-gray-900 text-l
            tracking-tight" id="text-institution">Selecione sua Instituição de Ensino</h4>

            <div th:if="${param.error}" class="bg-rose-100 justify-center p-4 ring-1 ring-rose-200 rounded-md">
                <p>Credenciais incorretas</p>
            </div>

            <div>
                <label class="block text-sm font-bold leading-6 text-gray-900" for="institutionName">Instituição</label>
                <div class="mt-1">
                    <select id="institutionName" name="institutionName" onchange="onInstitutionChange()"
                            class="ring-1 bg-white block w-full rounded-md h-10 py-1.5 text-gray-900 shadow-sm border-0 ring-inset ring-gray-300
                px-3 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-blue-600 sm:text-sm sm:leading-6">
                        <option value="">Selecione...</option>
                    </select>
                </div>
            </div>

            <div id="persona-container" style="display: none;">
                <label class="block text-sm font-bold leading-6 text-gray-900" for="persona">Função</label>
                <div class="mt-1">
                    <select id="persona" name="persona" onchange="onPersonaChange()"
                            class="ring-1 bg-white block w-full rounded-md py-1.5 h-10 text-gray-900 shadow-sm border-0 ring-inset ring-gray-300
                px-3 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-blue-600 sm:text-sm sm:leading-6">
                        <option value="">Selecione...</option>
                    </select>
                </div>
            </div>

            <div id="login-fields" style="display: none;">
                <div>
                    <label id="username-label" class="block text-sm font-bold leading-6 text-gray-900" for="username">Login</label>
                    <div class="mt-1">
                        <input class="ring-1 block w-full rounded-md py-1.5 h-10 text-gray-900 shadow-sm border-0 ring-inset
                    ring-gray-300 px-3 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-blue-600
                    sm:text-sm sm:leading-6"
                               id="username" name="username" type="text" placeholder="Login" maxlength="11"
                               oninput="this.value = this.value.replace(/[^0-9]/g, '').replace(/(\..*?)\..*/g, '$1');">
                    </div>
                </div>

                <div>
                    <label id="password-label" class="block text-sm font-bold leading-6 text-gray-900" for="password">Senha</label>
                    <div class="password-container">
                        <input class="ring-1 block w-full rounded-md h-10 py-1.5 text-gray-900 shadow-sm border-0 ring-inset
                         ring-gray-300 px-3 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-blue-600
                         sm:text-sm sm:leading-6"
                               id="password" name="password" type="password" placeholder="Senha">
                        <span class="toggle-password" onclick="togglePassword()">
                            <img th:src="@{/images/olho.png}" alt="Mostrar Senha" id="toggle-icon">
                        </span>
                    </div>
                </div>
            </div>

            <input type="hidden" id="assistenteId" name="assistenteId" th:value="${assistenteId}"/>

            <div>
                <input class="bg-blue-800 px-3 py-1.5 text-sm mt-8 font-semibold leading-6 text-white flex w-full
                justify-center rounded-md  shadow-sm ring-1 ring-inset hover:bg-blue-900 focus-visible:outline
                focus-visible:outline-offset-2 focus-visible:outline-blue-900"
                       type="submit" value="Entrar">
            </div>

        </form>
    </div>
</div>
</body>

<script>
    function togglePassword() {
        const passwordField = document.getElementById("password");
        const toggleIcon = document.getElementById("toggle-icon");
        const togglePasswordButton = document.querySelector(".toggle-password");

        if (passwordField.type === "password") {
            passwordField.type = "text";
            toggleIcon.alt = "Ocultar Senha";
            togglePasswordButton.classList.add("active");
        } else {
            passwordField.type = "password";
            toggleIcon.alt = "Mostrar Senha";
            togglePasswordButton.classList.remove("active");
        }
    }
</script>

<script th:inline="javascript">
    let institutions = [];
    const institutionSelect = document.getElementById("institutionName");
    const personaSelect = document.getElementById("persona");
    const personaContainer = document.getElementById("persona-container");
    const loginFields = document.getElementById("login-fields");
    const textInstitution = document.getElementById("text-institution");
    const usernameInput = document.getElementById("username");
    const passwordInput = document.getElementById("password");

    function resetFormState() {
        personaContainer.style.display = "none";
        loginFields.style.display = "none";
        usernameInput.required = false; // Garante que não seja obrigatório ao resetar
        passwordInput.required = false;
        personaSelect.innerHTML = '<option value="">Selecione...</option>';
        textInstitution.innerText = "Selecione sua Instituição de Ensino";
    }

    document.addEventListener("DOMContentLoaded", async function () {
        try {
            const response = await fetch(/*[[@{/api/institutions}]]*/ '');
            if (!response.ok) throw new Error('Falha ao buscar instituições');

            institutions = await response.json();

            institutions.forEach(inst => {
                const option = document.createElement("option");
                option.value = inst.shortName;
                option.textContent = inst.longName || inst.shortName.toUpperCase();
                institutionSelect.appendChild(option);
            });
        } catch (error) {
            console.error(error);
            textInstitution.innerText = "Erro ao carregar instituições.";
        }
        resetFormState();
    });

    function onInstitutionChange() {
        const selectedShortName = institutionSelect.value;
        const inst = institutions.find(i => i.shortName === selectedShortName);

        resetFormState();

        if (inst && inst.loginData && inst.loginData.length > 0) {
            inst.loginData.forEach(p => {
                const opt = document.createElement("option");
                opt.value = p.persona;
                opt.textContent = p.persona;
                personaSelect.appendChild(opt);
            });
            personaContainer.style.display = "block";
        }
    }

    function onPersonaChange() {
        const selectedShortName = institutionSelect.value;
        const selectedPersona = personaSelect.value;

        loginFields.style.display = "none";
        usernameInput.required = false;
        passwordInput.required = false;

        if (!selectedShortName || !selectedPersona) {
            return;
        }

        const inst = institutions.find(i => i.shortName === selectedShortName);
        const loginConfig = inst.loginData.find(p => p.persona === selectedPersona);

        if (loginConfig) {
            textInstitution.innerText = loginConfig.salutationPhrase;
            if (loginConfig.usernameField) {
                document.getElementById("username-label").innerText = loginConfig.usernameField;
                usernameInput.placeholder = loginConfig.usernameField;
                document.getElementById("password-label").innerText = loginConfig.passwordField;
                passwordInput.placeholder = loginConfig.passwordField;

                usernameInput.required = true;

                passwordInput.required = true;
                loginFields.style.display = "block";
            } else {
                loginFields.style.display = "none";
                usernameInput.required = false;
                passwordInput.required = false;
            }
        }
    }
</script>

</html>